[
    [
        "function_str",
        "def gradient_threshold(in_file, in_segm, thresh=1.0, out_file=None):\n    \"\"\" Compute a threshold from the histogram of the magnitude gradient image \"\"\"\n    import os.path as op\n    import numpy as np\n    import nibabel as nb\n    from scipy import ndimage as sim\n\n    struc = sim.iterate_structure(sim.generate_binary_structure(3, 2), 2)\n\n    if out_file is None:\n        fname, ext = op.splitext(op.basename(in_file))\n        if ext == '.gz':\n            fname, ext2 = op.splitext(fname)\n            ext = ext2 + ext\n        out_file = op.abspath(f'{fname}_gradmask{ext}')\n\n    imnii = nb.load(in_file)\n\n    hdr = imnii.header.copy()\n    hdr.set_data_dtype(np.uint8)  # pylint: disable=no-member\n\n    data = imnii.get_data().astype(np.float32)\n\n    mask = np.zeros_like(data, dtype=np.uint8)  # pylint: disable=no-member\n    mask[data > 15.] = 1\n\n    segdata = nb.load(in_segm).get_data().astype(np.uint8)\n    segdata[segdata > 0] = 1\n    segdata = sim.binary_dilation(\n        segdata, struc, iterations=2, border_value=1).astype(np.uint8)\n    mask[segdata > 0] = 1\n    mask = sim.binary_closing(mask, struc, iterations=2).astype(np.uint8)\n    # Remove small objects\n    label_im, nb_labels = sim.label(mask)\n    artmsk = np.zeros_like(mask)\n    if nb_labels > 2:\n        sizes = sim.sum(mask, label_im, list(range(nb_labels + 1)))\n        ordered = list(reversed(sorted(zip(sizes, list(range(nb_labels + 1))))))\n        for _, label in ordered[2:]:\n            mask[label_im == label] = 0\n            artmsk[label_im == label] = 1\n\n    mask = sim.binary_fill_holes(mask, struc).astype(np.uint8)  # pylint: disable=no-member\n\n    nb.Nifti1Image(mask, imnii.affine, hdr).to_filename(out_file)\n    return out_file\n"
    ],
    [
        "in_file",
        [
            "/home/kilimanjaro2/Research/monkeyStuff/mriqc/work/mriqc_wf/anatMRIQC/HeadMaskWorkflow/_in_file_..home..kilimanjaro2..Research..monkeyStuff..bidsData..sub-001..anat..sub-001_T1w.nii.gz/Grad/bias_corrected_enhanced_denoise_grad.nii.gz",
            "17a62178bb23d422565a93788062ae0f"
        ]
    ],
    [
        "in_segm",
        [
            "/home/kilimanjaro2/Research/monkeyStuff/mriqc/work/mriqc_wf/anatMRIQC/_in_file_..home..kilimanjaro2..Research..monkeyStuff..bidsData..sub-001..anat..sub-001_T1w.nii.gz/segmentation/segment_seg.nii.gz",
            "7b48f040cfee2e9c378623c6f6edccfb"
        ]
    ],
    [
        "needed_outputs",
        [
            "out_file"
        ]
    ]
]